# 公告自动过期功能说明

## 功能概述

公告模块现在支持自动检测和处理过期公告的功能。当公告的 `publishEndTime`（发布结束时间）过期后，系统会自动将其 `isPublished` 状态设置为 `false`，实现自动取消发布。

## 核心组件

### NoticeSchedulerService (定时任务服务)

负责执行定时任务，检查和更新过期公告状态。

**主要功能：**

- 每天晚上12点自动检查过期公告
- 批量更新过期公告状态为未发布
- 记录详细的操作日志

**定时任务配置：**

- 执行频率：每天晚上12点 (`0 0 * * *`)
- 时区：Asia/Shanghai
- 自动启动：模块初始化时启动

## 数据库查询优化

利用现有的数据库索引：

```sql
@@index([isPublished, publishStartTime, publishEndTime])
```

## 使用方式

### 自动运行

系统启动后，定时任务会自动开始运行，每天晚上12点执行一次过期公告检查，无需手动干预。

## 日志记录

系统会记录以下操作日志：

1. **定时任务启动/停止**

   ```
   公告自动过期检查定时任务已启动，每天晚上12点执行
   ```

2. **过期公告处理**

   ```
   成功将 3 个过期公告设置为未发布状态
   ```

3. **无过期公告**

   ```
   未发现过期的公告
   ```

4. **错误处理**
   ```
   检查过期公告时发生错误: [错误详情]
   ```

## 配置说明

### 检查频率

当前设置为每天晚上12点检查一次，如需调整频率，修改 `notice-scheduler.service.ts` 中的 cron 表达式：

```typescript
// 每天晚上12点执行
this.scheduledTask = cron.schedule('0 0 * * *', async () => {
  await this.checkAndUpdateExpiredNotices();
});

// 每天中午12点执行
this.scheduledTask = cron.schedule('0 12 * * *', async () => {
  await this.checkAndUpdateExpiredNotices();
});

// 每12小时执行一次
this.scheduledTask = cron.schedule('0 */12 * * *', async () => {
  await this.checkAndUpdateExpiredNotices();
});
```

## 性能考虑

1. **批量更新**：使用 `updateMany` 进行批量状态更新，提高性能
2. **索引优化**：利用现有的复合索引进行高效查询
3. **选择性查询**：只查询必要的字段，减少数据传输
4. **错误处理**：完善的异常捕获，避免单次错误影响后续执行

## 注意事项

1. **时区设置**：定时任务使用 Asia/Shanghai 时区，确保与业务时区一致
2. **数据库连接**：长时间运行的定时任务需要确保数据库连接稳定
3. **日志监控**：建议监控相关日志，及时发现异常情况
4. **执行时间**：选择在晚上12点执行，避免影响白天的业务操作

## 工作流程

1. **系统启动**：模块初始化时自动启动定时任务
2. **定时执行**：每天晚上12点自动执行过期检查
3. **查找过期公告**：查询所有已发布但过期的公告
4. **批量更新**：将过期公告的状态设置为未发布
5. **日志记录**：记录处理结果和详细信息
